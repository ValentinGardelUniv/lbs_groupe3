version: '3'

services:
  #############################
  ### API COMMANDE ET SUIVI ###
  #############################
  commande:
    image: node
    ports:
      - '3000:3000'
    env_file:
      - ./commande/.env.dev
    volumes:
      - ./commande:/usr/src/app
    working_dir: /usr/src/app
    #command: npm start
    #command: bash -c 'npm -i && npm start'
    command: bash -c 'npm i && npm run dev'
    links:
      - commande-suivi_db
  suivi:
    image: node
    ports:
      - '3003:3000'
    env_file:
      - ./suivi/.env.dev
    volumes:
      - ./suivi:/usr/src/app
    working_dir: /usr/src/app
    #command: npm start
    #command: bash -c 'npm -i && npm start'
    command: bash -c 'npm i && npm run dev'
    links:
      - commande-suivi_db
  commande-suivi_db:
    image: mariadb
    env_file:
      - ./commande-suivi_db/.env.dev
    volumes:
      - ./commande-suivi_db/data:/var/lib/mysql
    command: --character-set-server=utf8 --collation-server=utf8_general_ci
  ########################
  ### API FIDÃ‰LISATION ###
  ########################
  fidelisation:
    image: node
    ports:
      - '3002:3000'
    env_file:
      - ./fidelisation/.env.dev
    volumes:
      - ./fidelisation:/usr/src/app
    working_dir: /usr/src/app
    #command: npm start
    #command: bash -c 'npm -i && npm start'
    command: bash -c 'npm i && npm run dev'
    links:
      - fidelisation_db
  fidelisation_db:
    image: mariadb
    env_file:
      - ./fidelisation_db/.env.dev
    volumes:
      - ./fidelisation_db/data:/var/lib/mysql
    command: --character-set-server=utf8 --collation-server=utf8_general_ci
  adminer:
    image: adminer
    ports:
      - '4000:8080'
    links:
      - commande-suivi_db
      - fidelisation_db
  ################################
  ### API CATALOGUE ET GESTION ###
  ################################
  catalogue:
    image: node
    ports:
      - '3001:3000'
    env_file:
      - ./catalogue/.env.dev
    volumes:
      - ./catalogue:/usr/src/app
    working_dir: /usr/src/app
    #command: npm start
    #command: bash -c 'npm -i && npm start'
    command: bash -c 'npm i && npm run dev'
    links:
      - catalogue-gestion_db
  gestion:
    image: node
    ports:
      - '3004:3000'
    env_file:
      - ./gestion/.env.dev
    volumes:
      - ./gestion:/usr/src/app
    working_dir: /usr/src/app
    #command: npm start
    #command: bash -c 'npm -i && npm start'
    command: bash -c 'npm i && npm run dev'
    links:
      - catalogue-gestion_db
  catalogue-gestion_db:
    image: mongo
    env_file:
      - ./catalogue-gestion_db/.env.dev
    volumes:
      - ./catalogue-gestion_db/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
      - ./catalogue-gestion_db/data:/data/db
      - ./catalogue-gestion_db/schema:/var/schema
    working_dir: /var/schema
    command: [--auth]
  mongo-express:
    image: mongo-express
    ports:
      - '4001:8081'
    env_file:
      - ./mongo-express/.env.dev
    links:
      - catalogue-gestion_db
